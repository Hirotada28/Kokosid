# 実装計画: 収益化システム（Monetization System）

## 概要

Kokosidの収益化システムは、「心理的安全性」と「経済的持続性」を両立させる設計です。実装は基礎インフラから始まり、段階的に本気モード（Commitment Mode）の高度な機能を追加していきます。各ステップは前のステップの成果を基盤とし、最終的に統合された完全な収益化エコシステムを構築します。

## タスク

- [x] 1. データモデルとスキーマの実装
  - [x] 1.1 Isarローカルデータモデルの実装
    - Subscription、GemTransaction、CommitmentTask、GoldenSuccess、HonestyScoreRecord、SalvageSessionRecordコレクションの定義
    - インデックスとリレーションシップの設定
    - 暗号化フィールドの指定
    - _要件: 19.1, 19.2_
  
  - [x] 1.2 Supabaseスキーマの実装
    - subscriptions、gem_transactions、commitment_tasks、golden_successes、honesty_scores、salvage_sessions、payment_transactionsテーブルの作成
    - Row Level Security (RLS) ポリシーの設定
    - インデックスとトリガーの実装
    - _要件: 19.1, 19.4_
  
  - [x] 1.3 データモデルのプロパティテスト作成
    - **プロパティ1: ジェム残高計算の一貫性**
    - **検証: 要件 3.1, 3.2, 3.3**

- [x] 2. 決済システムの基盤実装
  - [x] 2.1 PaymentServiceインターフェースの実装
    - 抽象PaymentServiceクラスの定義
    - PaymentResult、Purchase等の共通データ型の実装
    - _要件: 6.1, 9.1, 9.2, 9.3_
  
  - [x] 2.2 iOS決済統合の実装
    - in_app_purchaseパッケージの統合
    - App Store Connect製品IDの設定
    - レシート検証ロジックの実装
    - サンドボックス/プロダクション環境の切り替え
    - _要件: 9.1, 9.4, 20.1_
  
  - [x] 2.3 Android決済統合の実装
    - in_app_purchaseパッケージの統合
    - Google Play Console製品IDの設定
    - レシート検証ロジックの実装
    - サンドボックス/プロダクション環境の切り替え
    - _要件: 9.2, 9.4, 20.2_
  
  - [x] 2.4 Web決済統合の実装
    - Stripe APIの統合
    - 決済フローの実装
    - Webhook処理の実装
    - _要件: 9.3, 9.4, 20.3_
  
  - [x] 2.5 決済処理のプロパティテスト作成
    - **プロパティ2: 決済トランザクションの整合性**
    - **検証: 要件 6.1, 6.2, 6.3**

- [x] 3. チェックポイント - 決済基盤の動作確認
  - 全てのテストが通ることを確認し、ユーザーに質問があれば対応する。

- [ ] 4. ジェム管理システムの実装
  - [ ] 4.1 GemRepositoryの実装
    - ジェムトランザクションのCRUD操作
    - ローカル（Isar）とクラウド（Supabase）の同期
    - _要件: 2.1, 2.2, 3.1_
  
  - [ ] 4.2 GemServiceの実装
    - ジェム購入処理（purchaseGems）
    - ジェム消費処理（consumeGems）
    - ジェム残高取得（getBalance）
    - 有効期限管理（expireOldGems）
    - Proプラン月次ジェム付与（grantMonthlyGems）
    - ジェムステーク処理（stakeGems、returnStakedGems、forfeitStakedGems）
    - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_
  
  - [ ] 4.3 ジェム管理のプロパティテスト作成
    - **プロパティ3: ジェム有効期限管理の正確性**
    - **検証: 要件 3.2, 3.6**
  
  - [ ] 4.4 ジェムステークのプロパティテスト作成
    - **プロパティ4: ジェムステークの可逆性**
    - **検証: 要件 11.6, 11.7**

- [ ] 5. サブスクリプション管理システムの実装
  - [ ] 5.1 SubscriptionRepositoryの実装
    - サブスクリプションのCRUD操作
    - ローカル（Isar）とクラウド（Supabase）の同期
    - _要件: 1.1, 1.2_
  
  - [ ] 5.2 SubscriptionServiceの実装
    - Proプラン購読開始（subscribeToPro）
    - サブスクリプションキャンセル（cancelSubscription）
    - サブスクリプション状態取得（getSubscriptionStatus）
    - サブスクリプション更新（renewSubscription）
    - 猶予期間管理（isInGracePeriod）
    - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8_
  
  - [ ] 5.3 サブスクリプション状態同期の実装
    - プラットフォーム間の状態同期（syncSubscriptionStatus）
    - リアルタイム状態ブロードキャスト
    - オフライン時のキャッシュ処理
    - _要件: 7.1, 7.2, 7.3, 7.4, 7.5_
  
  - [ ]* 5.4 サブスクリプション管理のプロパティテスト作成
    - **プロパティ5: サブスクリプション状態遷移の正確性**
    - **検証: 要件 1.1, 1.6, 1.7, 1.8**

- [ ] 6. 機能ゲートシステムの実装
  - [ ] 6.1 FeatureGateServiceの実装
    - AIレポートアクセス制御（canAccessAIReport）
    - マルチデバイス同期アクセス制御（canAccessMultiDeviceSync）
    - 本気モードアクセス制御（canAccessCommitmentMode）
    - 機能アクセスログ記録（logFeatureAccess）
    - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3, 5.4, 5.5, 8.1, 8.2, 8.3, 8.4, 8.5_
  
  - [ ]* 6.2 機能ゲートのプロパティテスト作成
    - **プロパティ6: 機能アクセス制御の一貫性**
    - **検証: 要件 8.1, 8.2, 8.3, 8.4**

- [ ] 7. チェックポイント - 基礎インフラの統合確認
  - 全てのテストが通ることを確認し、ユーザーに質問があれば対応する。

- [ ] 8. 本気モード: ステークシステムの実装
  - [ ] 8.1 CommitmentRepositoryの実装
    - CommitmentTaskのCRUD操作
    - ローカル（Isar）とクラウド（Supabase）の同期
    - _要件: 11.1, 11.8_
  
  - [ ] 8.2 CommitmentModeEngineの実装
    - ステーク設定（setStake）
    - AI伴走レベル判定（getCompanionLevel）
    - タスク完了報酬計算（calculateReward）
    - _要件: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.7, 11.8, 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 12.7_
  
  - [ ] 8.3 ステークUIの実装
    - タスク作成時のステークレベル選択UI（0, 1, 3, 5 Gems）
    - ステークレベル別の説明表示
    - ジェム残高確認とエラーハンドリング
    - Proプラン限定機能の案内（無料プランユーザー向け）
    - _要件: 11.1, 11.2_
  
  - [ ]* 8.4 ステークシステムのプロパティテスト作成
    - **プロパティ7: ステーク設定の制約遵守**
    - **検証: 要件 11.1, 11.3, 11.4, 11.5, 11.6**

- [ ] 9. 本気モード: タスク完了と報酬システムの実装
  - [ ] 9.1 タスク完了処理の実装
    - ステークされたジェムの返却処理
    - 達成スコア計算（基本スコア × ステーク倍率 × 誠実性ボーナス）
    - ステークレベル別のお祝い演出トリガー
    - _要件: 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 12.7_
  
  - [ ] 9.2 5 Gemsステーク特別演出の実装
    - 特別な祝祭アニメーション（紙吹雪 + サウンド）
    - 黄金の成功体験アーカイブへの保存
    - 達成スコア1.5倍の適用
    - _要件: 12.4, 12.5, 12.6_
  
  - [ ]* 9.3 報酬計算のプロパティテスト作成
    - **プロパティ8: 報酬計算の正確性**
    - **検証: 要件 12.1, 12.2, 12.3, 12.4, 12.7**

- [ ] 10. 本気モード: 正直な撤退ボタンの実装
  - [ ] 10.1 正直な撤退UIの実装
    - タスク詳細画面への「正直な撤退」ボタン配置
    - 責めない言葉遣いの確認ダイアログ
    - 任意の失敗理由入力フィールド
    - _要件: 13.1, 13.2_
  
  - [ ] 10.2 失敗報告処理の実装
    - タスクステータスの「正直に失敗」への更新
    - ステークされたジェムの没収処理
    - 誠実性スコアの増加（+5ポイント）
    - サルベージ機能の案内表示
    - _要件: 13.3, 13.4, 13.5, 13.6, 13.7, 13.8_
  
  - [ ]* 10.3 正直な撤退のプロパティテスト作成
    - **プロパティ9: 正直な失敗報告の報酬**
    - **検証: 要件 13.5, 17.2, 17.3**

- [ ] 11. 本気モード: 誠実性スコアシステムの実装
  - [ ] 11.1 HonestyScoreServiceの実装
    - 誠実性スコア取得（getScore）
    - スコア増加処理（increaseScore）
    - スコア減少処理（decreaseScore）
    - ブースト率計算（calculateBoostRate）
    - スコア履歴管理（getHistory）
    - _要件: 17.1, 17.2, 17.3, 17.4, 17.5, 17.6, 17.7, 17.8, 17.9_
  
  - [ ] 11.2 誠実性スコアUIの実装
    - 現在スコアの表示
    - 次のブースト閾値の表示
    - スコア履歴グラフの表示
    - ブースト率の説明
    - _要件: 17.7_
  
  - [ ]* 11.3 誠実性スコアのプロパティテスト作成
    - **プロパティ10: 誠実性スコアとブースト率の関係**
    - **検証: 要件 17.5, 17.6**

- [ ] 12. チェックポイント - 本気モードコア機能の統合確認
  - 全てのテストが通ることを確認し、ユーザーに質問があれば対応する。

- [ ] 13. 本気モード: AI伴走レベルの実装
  - [ ] 13.1 AI伴走レベル判定の実装
    - ステークレベルに応じたAICompanionLevelの設定
    - 伴走レベル別の応答優先度設定
    - _要件: 15.1, 15.2, 15.3, 15.4, 15.5, 15.6, 15.7, 15.8_
  
  - [ ] 13.2 能動的リマインドシステムの実装
    - 3 Gemsステーク: 期限24時間前の1回リマインド
    - リマインド内容の生成（タスク重要性の再確認、心理的障壁の確認）
    - _要件: 15.3, 15.4_
  
  - [ ] 13.3 3段階サポートシステムの実装
    - 実行前サポート（タスク作成後24時間以内）: 意図確認と心理的準備
    - 実行中サポート（期限50%経過時点）: 進捗確認と障壁除去
    - 完了後サポート（完了直後）: 振り返りと成功体験の言語化
    - _要件: 15.5, 15.6_
  
  - [ ] 13.4 優先応答システムの実装
    - 5 Gemsステークタスクの応答時間50%短縮
    - 応答キューの優先度管理
    - _要件: 15.6_
  
  - [ ] 13.5 伴走一時停止機能の実装
    - ユーザーの「今は話したくない」意思の検出
    - 伴走の即座停止とリマインド延期（24時間後）
    - _要件: 15.7, 15.8_
  
  - [ ]* 13.6 AI伴走のプロパティテスト作成
    - **プロパティ11: AI伴走レベルの適切な調整**
    - **検証: 要件 15.1, 15.3, 15.5**

- [ ] 14. 本気モード: 黄金の成功体験アーカイブの実装
  - [ ] 14.1 黄金の成功体験保存の実装
    - 5 Gemsステーク完了時の自動アーカイブ
    - タスク詳細、達成日時、感情状態、AI伴走ログの保存
    - E2E暗号化の適用
    - _要件: 16.1, 16.2_
  
  - [ ] 14.2 黄金の成功体験検索と引用の実装
    - 関連する黄金の成功体験の検索アルゴリズム
    - AIコーチングでの具体的な引用生成
    - _要件: 16.3, 16.4_
  
  - [ ] 14.3 黄金の成功体験UIの実装
    - 時系列順の一覧表示
    - 各体験のサムネイル（タスク名、日付、感情）
    - 詳細表示（完全な詳細、AI伴走ログ、振り返りコメント）
    - _要件: 16.5, 16.6_
  
  - [ ]* 14.4 黄金の成功体験のプロパティテスト作成
    - **プロパティ12: 黄金の成功体験の永続性**
    - **検証: 要件 16.2, 16.7**

- [ ] 15. 本気モード: サルベージ機能の実装
  - [ ] 15.1 SalvageServiceの実装
    - サルベージ利用可否確認（checkAvailability）
    - リカバリーセッション開始（startRecoverySession）
    - セッション進行（progressSession）
    - セッション完了（completeSession）
    - 月次カウントリセット（resetMonthlyCounts）
    - _要件: 14.1, 14.2, 14.3, 14.4, 14.5, 14.6, 14.7, 14.8, 14.9_
  
  - [ ] 15.2 4段階リカバリーセッションの実装
    - 認知的脱フュージョン: 失敗を責める思考からの距離化
    - 受容の促進: 「今は休む時間」の受容と自己批判軽減
    - 次へのブリッジ: 5分でできる超・マイクロタスクの提案
    - パターン分析: 失敗の背景要因分析と次回成功確率向上
    - _要件: 14.5, 14.6_
  
  - [ ] 15.3 サルベージUIの実装
    - 失敗報告後のサルベージ案内表示
    - Proプラン: 残り無料回数の表示
    - 無料プラン/4回目以降: 1 Gem消費の確認
    - リカバリーセッションの対話UI
    - サルベージ履歴の表示
    - _要件: 14.1, 14.2, 14.3, 14.4, 14.9_
  
  - [ ]* 15.4 サルベージ機能のプロパティテスト作成
    - **プロパティ13: サルベージ利用回数の正確な管理**
    - **検証: 要件 14.2, 14.3, 14.8**

- [ ] 16. チェックポイント - 本気モード拡張機能の統合確認
  - 全てのテストが通ることを確認し、ユーザーに質問があれば対応する。

- [ ] 17. 本気モード: 分析とインサイトの実装
  - [ ] 17.1 本気モード統計の実装
    - 週間ステーク総数（レベル別）の集計
    - 成功率（レベル別）の計算
    - 獲得達成スコアの集計
    - 誠実性スコア変動の追跡
    - _要件: 18.1_
  
  - [ ] 17.2 本気モード深い分析の実装
    - 最も成功しやすいステークレベルの分析
    - 失敗パターンの分析（時間帯、タスクタイプ）
    - 黄金の成功体験の振り返り
    - 次月への推奨戦略の生成
    - _要件: 18.2, 18.3_
  
  - [ ] 17.3 本気モードダッシュボードUIの実装
    - 現在のステーク中タスク数の表示
    - 今月の成功率の表示
    - 利用可能ジェム残高の表示
    - サルベージ残り無料回数の表示（Proプランのみ）
    - _要件: 18.4_
  
  - [ ] 17.4 本気モードタスク検索の実装
    - ステークレベルでのフィルタリング
    - 成功/失敗でのフィルタリング
    - 日付範囲でのフィルタリング
    - _要件: 18.5_

- [ ] 18. UI/UX統合とユーザーフロー実装
  - [ ] 18.1 サブスクリプション購入フローの実装
    - Proプラン紹介画面
    - 機能比較表（無料プラン vs Proプラン）
    - 購入確認画面
    - 購入完了とウェルカムメッセージ
    - _要件: 1.1, 1.2_
  
  - [ ] 18.2 ジェム購入フローの実装
    - ジェム残高表示
    - ジェムチャージ購入画面
    - 有効期限の説明
    - 購入確認と完了
    - _要件: 2.1, 2.2_
  
  - [ ] 18.3 機能ゲートUIの実装
    - プレミアム機能へのアクセス時のゲート表示
    - 要件説明（Proプランまたはジェムコスト）
    - アップグレード/購入への誘導
    - _要件: 8.3_
  
  - [ ] 18.4 ジェム使用履歴UIの実装
    - トランザクション履歴の表示
    - 日付、量、タイプ、理由の表示
    - 有効期限の表示
    - _要件: 10.4_

- [ ] 19. オフライン対応とデータ同期の実装
  - [ ] 19.1 オフライン時の本気モード操作の実装
    - ステークされたタスクのローカル作成
    - タスク完了のローカル処理
    - 失敗報告のローカル処理
    - _要件: 21.1, 21.2, 21.3_
  
  - [ ] 19.2 オンライン復帰時の同期処理の実装
    - ローカル変更のバックエンド送信
    - 競合解決（最新タイムスタンプ優先）
    - ジェム残高の整合性確認
    - _要件: 21.4, 21.5, 21.7_
  
  - [ ] 19.3 オフライン制限の実装
    - サルベージ機能のオンライン要件通知
    - 決済処理のオンライン要件通知
    - _要件: 21.6_
  
  - [ ]* 19.4 オフライン同期のプロパティテスト作成
    - **プロパティ14: オフライン操作の同期整合性**
    - **検証: 要件 21.1, 21.4, 21.5**

- [ ] 20. セキュリティとプライバシーの実装
  - [ ] 20.1 決済セキュリティの実装
    - すべての決済通信にHTTPS/TLS使用
    - クレジットカード情報の非保存（決済プロバイダーに委譲）
    - _要件: 6.1, 22.1, 22.2_
  
  - [ ] 20.2 ジェム操作の監査ログの実装
    - ジェム残高変更のトランザクションログ記録
    - 不正なジェム操作のアノマリー検出
    - _要件: 22.3, 22.4_
  
  - [ ] 20.3 E2E暗号化の実装
    - 黄金の成功体験のE2E暗号化
    - サルベージセッション内容のE2E暗号化
    - AI伴走ログのE2E暗号化
    - _要件: 22.5, 22.6_
  
  - [ ] 20.4 GDPR準拠のデータ削除の実装
    - アカウント削除時の完全データ削除
    - 黄金の成功体験を含むすべてのデータの削除
    - 決済トランザクションの7年間保存（法的要件）
    - _要件: 16.7, 22.7, 22.8_
  
  - [ ]* 20.5 セキュリティのプロパティテスト作成
    - **プロパティ15: ジェム操作の監査証跡**
    - **検証: 要件 22.3, 22.4**

- [ ] 21. エラーハンドリングとユーザー通知の実装
  - [ ] 21.1 決済エラーハンドリングの実装
    - エラー種類の明確な表示（カード拒否、ネットワークエラー等）
    - リトライロジック（最大3回）
    - ローディング状態の適切な表示
    - _要件: 6.3, 20.6, 20.7, 24.1_
  
  - [ ] 21.2 ジェム不足エラーの実装
    - 必要なジェム数の表示
    - 購入オプションの表示
    - _要件: 24.2_
  
  - [ ] 21.3 サブスクリプション更新失敗の通知実装
    - プッシュ通知の送信
    - メール通知の送信
    - アプリ内通知の表示
    - _要件: 1.6, 24.3_
  
  - [ ] 21.4 エラーメッセージの最適化
    - 技術的詳細を避けたユーザーフレンドリーな言葉
    - 解決策の提示
    - サポート連絡先の表示
    - _要件: 24.4, 24.5, 24.7_
  
  - [ ] 21.5 エラーログとモニタリングの実装
    - 本気モードエンジンのエラーログ記録
    - 開発チームへの通知
    - _要件: 24.6_

- [ ] 22. パフォーマンス最適化の実装
  - [ ] 22.1 決済処理のパフォーマンス最適化
    - 決済処理30秒以内の完了
    - タイムアウト処理の実装
    - _要件: 23.1_
  
  - [ ] 22.2 サブスクリプション状態同期の最適化
    - 状態変更の60秒以内の全デバイス反映
    - リアルタイムブロードキャストの実装
    - _要件: 23.2_
  
  - [ ] 22.3 ジェム残高更新の最適化
    - 5秒以内の更新完了
    - 楽観的UI更新の実装
    - _要件: 23.3_
  
  - [ ] 22.4 本気モードエンジンの最適化
    - ステーク設定3秒以内の処理
    - 5 Gemsステークタスクの優先応答50%短縮
    - _要件: 23.4, 23.5_

- [ ] 23. テストとQAの実装
  - [ ] 23.1 ユニットテストの実装
    - ジェム残高計算のテスト
    - ステーク報酬計算のテスト
    - 誠実性スコア変動のテスト
    - 有効期限管理のテスト
    - ブースト率計算のテスト
    - _要件: 25.1_
  
  - [ ] 23.2 統合テストの実装
    - サブスクリプション購入フロー（エンドツーエンド）
    - ジェム購入フロー（エンドツーエンド）
    - 本気モードタスク作成から完了まで
    - サルベージセッションフロー
    - 黄金の成功体験作成と引用
    - _要件: 25.2_
  
  - [ ] 23.3 エッジケーステストの実装
    - ジェム残高がちょうど0の場合
    - 有効期限が今日の場合
    - サブスクリプション更新日とジェム付与のタイミング
    - オフライン時の本気モード操作
    - 同時に複数のステークタスクを完了
    - _要件: 25.3_
  
  - [ ] 23.4 決済モックテストの実装
    - 実際の課金なしでの決済フローテスト
    - プラットフォーム別のモック実装
    - _要件: 25.4_
  
  - [ ]* 23.5 パフォーマンステストの実装
    - 1000件のジェムトランザクション処理
    - 100件の同時サブスクリプション更新
    - 大量の黄金の成功体験検索
    - _要件: 25.5_

- [ ] 24. チェックポイント - 全システム統合確認
  - 全てのテストが通ることを確認し、ユーザーに質問があれば対応する。

- [ ] 25. 最終統合とドキュメント作成
  - [ ] 25.1 全機能の統合テスト
    - エンドツーエンドフローの検証
      - Proプラン購読 → 30 Gems付与 → 本気モードタスク作成 → 完了 → 報酬獲得
      - 無料プラン → ジェム購入 → 本気モード試用 → 失敗 → サルベージ利用
      - 5 Gemsステーク → 完了 → 黄金の成功体験保存 → 後のコーチングで引用
    - パフォーマンステスト（応答時間の検証）
    - メモリリーク検出とプロファイリング
    - _全要件の統合検証_
  
  - [ ] 25.2 セキュリティ監査
    - 決済セキュリティの検証（HTTPS/TLS）
    - E2E暗号化の検証（AES-256）
    - プライバシー保護機能の確認
    - 脆弱性スキャン実行
    - _要件: 22.1, 22.2, 22.5, 22.6_
  
  - [ ] 25.3 ユーザビリティテスト準備
    - 本気モードオンボーディングフローの最適化
      - ステークシステムの説明
      - 正直な撤退ボタンの価値説明
      - サルベージ機能の紹介
    - アクセシビリティ対応
      - スクリーンリーダー対応
      - 色覚多様性への配慮
    - 多言語対応の準備（日本語・英語）
  
  - [ ] 25.4 ドキュメント作成
    - 収益化システムの技術ドキュメント
    - 本気モードの運用ガイド
    - 決済統合のトラブルシューティングガイド
    - API仕様書
    - データモデル図

- [ ] 26. 最終チェックポイント - リリース準備完了確認
  - 全てのテストが通ることを確認し、ユーザーに質問があれば対応する。

## 注記

- `*`マークの付いたタスクはオプションであり、MVP開発を優先する場合はスキップ可能です
- 各タスクは前のタスクの成果を基盤とし、段階的に機能を構築します
- チェックポイントタスクでは、進捗確認と問題の早期発見を行います
- プロパティテストは各機能の正確性を保証し、回帰バグを防止します
- 本気モードは心理的安全性を最優先とし、失敗を受容する設計です
- すべての決済処理とジェム操作は監査証跡を残し、透明性を確保します

## 実装優先順位

### フェーズ1：基礎インフラ（タスク1-7）
- データモデルとスキーマ
- 決済システム統合
- ジェム管理
- サブスクリプション管理
- 機能ゲート

### フェーズ2：本気モードコア（タスク8-12）
- ステークシステム
- タスク完了と報酬
- 正直な撤退ボタン
- 誠実性スコア

### フェーズ3：本気モード拡張（タスク13-17）
- AI伴走レベル
- 黄金の成功体験
- サルベージ機能
- 分析とインサイト

### フェーズ4：統合と最適化（タスク18-26）
- UI/UX統合
- オフライン対応
- セキュリティ
- パフォーマンス最適化
- テストとQA
