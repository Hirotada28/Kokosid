# 要件定義書：収益化システム

## はじめに

本文書は、Flutter ベースの ACT（アクセプタンス＆コミットメント・セラピー）セルフマネジメントアプリ「Kokosid」における収益化システムの実装要件を定義します。このシステムには、月額サブスクリプションプラン（Pro プラン）、単発のジェム購入、そしてProプラン限定の「本気モード（Commitment Mode）」が含まれます。実装は Supabase をバックエンドとして、モバイルおよび Web プラットフォームの両方をサポートする必要があります。

## プロダクトビジョン

Kokosidのマネタイゼーション戦略は、「心理的安全性」と「経済的持続性」を両立させることを目指しています。無料プランでプライバシーとセルフケアの基本を提供し、Proプランで人生を変える本気の伴走を実現します。

## 用語集

### 基本用語
- **ユーザー**: セルフマネジメントアプリを使用する人
- **無料プラン (Standard)**: 基本機能とオンデバイスAI（Llama 3.2）を提供する無料プラン
- **Pro_プラン (Partner)**: 月額 ¥1,480（税込）のサブスクリプションで、毎月 30 ジェムを付与し、プレミアム機能をアンロックする
- **ジェム**: アプリ内のプレミアム機能にアクセスするために使用される仮想通貨単位。「自己投資の可視化」と「心理的コミットメントの強化」を目的とする
- **ジェムチャージ**: ¥1,200（税込）で 12 ジェムを購入する単発購入で、180 日間の有効期限がある

### プレミアム機能
- **AI_レポート**: ユーザーデータに基づいて AI による洞察とレポートを生成するプレミアム機能（週次・月次）
- **マルチデバイス同期**: 複数のデバイス間でユーザーデータをE2E暗号化して同期するプレミアム機能
- **本気モード (Commitment Mode)**: Proプラン限定。ジェムをステークしてタスクにコミットし、AI伴走を強化する機能
- **ステーク (Stake)**: 本気モードでタスクに賭けるジェムの数（1〜5個）。損失回避性を活用した心理的コミットメント
- **正直な撤退ボタン (Failure Acceptance)**: タスク失敗を1タップで報告できるUI。認知不協和を防ぎ、心理的柔軟性を維持
- **サルベージ機能 (Salvage)**: 本気モードで失敗した際のAIリカバリーセッション。Proプランは月3回無料
- **誠実性スコア (Honesty Score)**: 失敗を正直に報告することで上昇するスコア。次回成功時の報酬をブースト
- **黄金の成功体験 (Golden Success)**: 5 Gemsステークで達成したタスクの永久アーカイブ。後のコーチングに引用される

### システムコンポーネント
- **決済システム**: アプリに統合された外部決済処理サービス（iOS: In-App Purchase、Android: Play Billing、Web: 決済ゲートウェイ）
- **サブスクリプション管理**: サブスクリプションのライフサイクルを管理するシステムコンポーネント
- **ジェム管理**: ジェム残高と有効期限を追跡するシステムコンポーネント
- **機能ゲート**: サブスクリプション状態またはジェムの利用可能性に基づいてプレミアム機能へのアクセスを制御するシステムコンポーネント
- **本気モードエンジン**: ステーク、AI伴走、リカバリーセッションを管理するコンポーネント
- **バックエンド**: Supabase ベースのサーバーインフラストラクチャ
- **有効期限**: 購入したジェムが無効になる日付（購入日から 180 日後）。Proプラン付与ジェムは無期限

## 要件

### 要件 1：Pro プランのサブスクリプション管理

**ユーザーストーリー：** ユーザーとして、Pro プランに登録することで、プレミアム機能にアクセスし、毎月ジェムを受け取りたい。

#### 受入基準

1. WHEN ユーザーが Pro プランのサブスクリプションを開始する、THE サブスクリプション管理 SHALL 決済システムを通じて ¥1,480 の決済を処理する
2. WHEN Pro プランのサブスクリプションが正常にアクティブ化される、THE サブスクリプション管理 SHALL ユーザーのアカウントに即座に 30 ジェムを付与する
3. WHEN Pro プランのサブスクリプションがアクティブである、THE 機能ゲート SHALL そのユーザーの AI_レポート機能をアンロックする
4. WHEN Pro プランのサブスクリプションがアクティブである、THE 機能ゲート SHALL そのユーザーのマルチデバイス同期機能をアンロックする
5. WHEN Pro プランのサブスクリプションが毎月更新される、THE サブスクリプション管理 SHALL ユーザーのアカウントに追加で 30 ジェムを付与する
6. WHEN Pro プランのサブスクリプション更新が失敗する、THE サブスクリプション管理 SHALL ユーザーに通知し、3 日間の猶予期間中はアクセスを維持する
7. WHEN ユーザーが Pro プランのサブスクリプションをキャンセルする、THE サブスクリプション管理 SHALL 現在の請求期間の終了までアクセスを維持する
8. WHEN キャンセル後に Pro プランのサブスクリプションが期限切れになる、THE 機能ゲート SHALL AI_レポートとマルチデバイス同期機能へのアクセスを取り消す

### 要件 2：単発ジェム購入

**ユーザーストーリー：** ユーザーとして、サブスクリプションにコミットせずにプレミアム機能にアクセスするために、個別にジェムを購入したい。

#### 受入基準

1. WHEN ユーザーがジェムチャージ購入を開始する、THE 決済システム SHALL ¥1,200 の決済を処理する
2. WHEN ジェムチャージ購入が正常に完了する、THE ジェム管理 SHALL ユーザーのアカウントに 12 ジェムを追加する
3. WHEN ジェムチャージ購入からジェムが追加される、THE ジェム管理 SHALL 有効期限を購入日から 180 日後に設定する
4. WHEN ユーザーがジェム残高を表示する、THE ジェム管理 SHALL 利用可能な総ジェム数と最も早い有効期限を表示する
5. WHEN 購入トランザクションが失敗する、THE 決済システム SHALL エラーメッセージを返し、THE ジェム管理 SHALL ユーザーのジェム残高を変更しない

### 要件 3：ジェム残高と有効期限管理

**ユーザーストーリー：** ユーザーとして、ジェム残高が有効期限とともに正確に追跡されることで、ジェムがいつ期限切れになるかを理解したい。

#### 受入基準

1. WHEN 機能のためにジェムが消費される、THE ジェム管理 SHALL 最も早い有効期限を持つジェムから優先的に差し引く
2. WHEN 現在の日付がジェムバッチの有効期限に達する、THE ジェム管理 SHALL それらの期限切れジェムをユーザーの残高から削除する
3. WHEN ユーザーが異なる有効期限を持つ複数のジェムバッチを持つ、THE ジェム管理 SHALL 各バッチを個別に追跡する
4. WHEN ユーザーが Pro プランの月次ジェムを受け取る、THE ジェム管理 SHALL それらのジェムを無期限としてマークする
5. WHEN ユーザーのジェム残高が変更される、THE バックエンド SHALL 更新された残高を即座に永続化する
6. WHEN ジェムが 7 日以内に期限切れになる、THE ジェム管理 SHALL ユーザーに期限切れが近いことを通知する

### 要件 4：AI レポート機能へのアクセス

**ユーザーストーリー：** ユーザーとして、ジェムまたは Pro プランのサブスクリプションを使用して AI レポートを生成し、進捗に関する洞察を得たい。

#### 受入基準

1. WHEN アクティブな Pro プランを持つユーザーが AI_レポートをリクエストする、THE 機能ゲート SHALL ジェムを消費せずにアクセスを許可する
2. WHEN アクティブな Pro プランを持たないユーザーが AI_レポートをリクエストする、THE 機能ゲート SHALL ユーザーが十分なジェムを持っているか確認する
3. WHEN 十分なジェムを持つ非 Pro ユーザーが AI_レポートをリクエストする、THE ジェム管理 SHALL 必要なジェムを差し引き、THE AI_レポート SHALL 生成される
4. WHEN 十分なジェムを持たない非 Pro ユーザーが AI_レポートをリクエストする、THE 機能ゲート SHALL アクセスを拒否し、ジェム要件を表示する
5. IF AI_レポート生成中にユーザーの Pro プランが期限切れになる、THEN THE 機能ゲート SHALL レポートの完了を許可する

### 要件 5：マルチデバイス同期機能へのアクセス

**ユーザーストーリー：** ユーザーとして、Pro プランを持っているときに複数のデバイス間でデータを同期し、どこからでも情報にアクセスしたい。

#### 受入基準

1. WHEN アクティブな Pro プランを持つユーザーが新しいデバイスでログインする、THE マルチデバイス同期 SHALL バックエンドからすべてのユーザーデータを同期する
2. WHEN アクティブな Pro プランを持つユーザーが任意のデバイスで変更を行う、THE マルチデバイス同期 SHALL それらの変更を即座にバックエンドに伝播する
3. WHEN アクティブな Pro プランを持たないユーザーが同期を有効にしようとする、THE 機能ゲート SHALL アクセスを拒否し、Pro プラン要件を表示する
4. WHEN ユーザーの Pro プランが期限切れになる、THE マルチデバイス同期 SHALL 自動同期を無効にするが、すべてのデバイス上の既存データは保持する
5. WHEN デバイス間で同期の競合が発生する、THE マルチデバイス同期 SHALL 最新のタイムスタンプを使用して競合を解決する

### 要件 6：決済処理とトランザクション管理

**ユーザーストーリー：** ユーザーとして、決済が安全かつ確実に処理されることで、収益化システムを信頼したい。

#### 受入基準

1. WHEN 決済が開始される、THE 決済システム SHALL すべてのトランザクションデータに対して安全な HTTPS 接続を使用する
2. WHEN 決済が正常に処理される、THE バックエンド SHALL タイムスタンプ、金額、トランザクションタイプを含むトランザクションレコードを作成する
3. WHEN 決済が失敗する、THE 決済システム SHALL 特定のエラーコードを返し、THE バックエンド SHALL 失敗をログに記録する
4. WHEN 購入から 7 日以内に返金がリクエストされる、THE バックエンド SHALL 返金を処理し、THE ジェム管理 SHALL 対応するジェムを差し引く
5. IF 返金によってジェム残高がマイナスになる、THEN THE ジェム管理 SHALL 残高をゼロに設定し、アカウントをレビュー対象としてフラグを立てる
6. WHEN トランザクションが完了する、THE バックエンド SHALL ユーザーの登録メールアドレスに領収書を送信する

### 要件 7：サブスクリプション状態の同期

**ユーザーストーリー：** ユーザーとして、すべてのプラットフォームでサブスクリプション状態が一貫していることで、プレミアム機能へのシームレスなアクセスを得たい。

#### 受入基準

1. WHEN ユーザーがモバイルでサブスクライブする、THE バックエンド SHALL サブスクリプション状態を更新し、THE 機能ゲート SHALL 30 秒以内に Web 上で変更を反映する
2. WHEN ユーザーが Web でサブスクライブする、THE バックエンド SHALL サブスクリプション状態を更新し、THE 機能ゲート SHALL 30 秒以内にモバイル上で変更を反映する
3. WHEN アプリが起動する、THE サブスクリプション管理 SHALL バックエンドで現在のサブスクリプション状態を検証する
4. WHEN サブスクリプション状態が変更される、THE バックエンド SHALL すべてのアクティブなユーザーセッションに変更をブロードキャストする
5. WHEN ネットワーク接続が失われる、THE 機能ゲート SHALL ローカルにキャッシュされた最後に既知のサブスクリプション状態を使用する

### 要件 8：機能ゲートの実施

**ユーザーストーリー：** システム管理者として、プレミアム機能が適切にゲートされることで、認可されたユーザーのみがアクセスできるようにしたい。

#### 受入基準

1. WHEN ユーザーが AI_レポートにアクセスしようとする、THE 機能ゲート SHALL アクセスを許可する前にアクティブな Pro プランまたは十分なジェム残高を検証する
2. WHEN ユーザーがマルチデバイス同期を有効にしようとする、THE 機能ゲート SHALL アクセスを許可する前にアクティブな Pro プラン状態を検証する
3. WHEN 機能アクセスが拒否される、THE 機能ゲート SHALL 要件（Pro プランまたはジェムコスト）を説明する明確なメッセージを表示する
4. WHEN 機能使用中にユーザーの認可が変更される、THE 機能ゲート SHALL 操作を完了する前に認可を再検証する
5. THE 機能ゲート SHALL すべてのアクセス試行と認可決定を監査目的でバックエンドにログ記録する

### 要件 9：プラットフォーム固有の決済統合

**ユーザーストーリー：** ユーザーとして、プラットフォームのネイティブ決済方法を使用することで、馴染みのある安全な決済体験を得たい。

#### 受入基準

1. WHEN ユーザーが iOS で決済を開始する、THE 決済システム SHALL Apple In-App Purchase API を使用する
2. WHEN ユーザーが Android で決済を開始する、THE 決済システム SHALL Google Play Billing API を使用する
3. WHEN ユーザーが Web で決済を開始する、THE 決済システム SHALL Web 互換の決済ゲートウェイを使用する
4. WHEN プラットフォーム決済が完了する、THE バックエンド SHALL プラットフォームのレシート検証サービスでトランザクションを検証する
5. WHEN レシート検証が失敗する、THE バックエンド SHALL 購入アイテムを付与せず、検証失敗をログに記録する

### 要件 10：ジェム使用追跡と分析

**ユーザーストーリー：** システム管理者として、ジェム使用パターンを追跡することで、収益化戦略を最適化したい。

#### 受入基準

1. WHEN ユーザーがジェムを消費する、THE バックエンド SHALL ジェム量、使用された機能、タイムスタンプを記録する
2. WHEN ユーザーがジェムを受け取る、THE バックエンド SHALL ソース（サブスクリプション、購入、またはプロモーション）、量、タイムスタンプを記録する
3. WHEN 分析レポートを生成する、THE バックエンド SHALL 機能タイプと期間別にジェム使用を集計する
4. WHEN ユーザーがトランザクション履歴を表示する、THE バックエンド SHALL すべてのジェム取得と消費を日付とともに表示する
5. THE バックエンド SHALL 月間アクティブサブスクライバーとジェム購入コンバージョン率を計算して保存する

---

## 本気モード（Commitment Mode）関連要件

### 要件 11：ステーク（賭け金）システム

**ユーザーストーリー：** Proプランユーザーとして、タスクにジェムをステークすることで、損失回避性を活用して実行動機を高めたい。

#### 受入基準

1. WHEN Proプランユーザーがタスクを作成する、THE 本気モードエンジン SHALL ステークレベル（0, 1, 3, 5 Gems）の選択UIを表示する
2. WHEN 無料プランユーザーがタスクを作成する、THE 本気モードエンジン SHALL ステーク機能を表示せず、Proプランへのアップグレード案内を表示する
3. WHEN ユーザーが1 Gemをステークする、THE 本気モードエンジン SHALL 通常の達成スコアを設定し、AI伴走レベルを「静かに見守る」に設定する
4. WHEN ユーザーが3 Gemsをステークする、THE 本気モードエンジン SHALL 達成スコア1.2倍を設定し、期限前に1回の能動的リマインドをスケジュールする
5. WHEN ユーザーが5 Gemsをステークする、THE 本気モードエンジン SHALL 達成スコア1.5倍を設定し、優先的AI応答と3段階サポート（実行前・実行中・完了後）を有効化する
6. WHEN ユーザーがステークを設定する、THE ジェム管理 SHALL ユーザーの利用可能ジェム残高を確認し、不足している場合はステークを拒否する
7. WHEN ステークが設定される、THE ジェム管理 SHALL ステークされたジェムを「保留中」としてマークし、利用可能残高から差し引く
8. WHEN ステークされたタスクが作成される、THE バックエンド SHALL タスクID、ステーク量、タイムスタンプ、AI伴走レベルを記録する

### 要件 12：タスク完了とステーク報酬

**ユーザーストーリー：** ユーザーとして、ステークしたタスクを完了することで、設定された報酬とお祝いを受け取りたい。

#### 受入基準

1. WHEN ユーザーがステークされたタスクを完了する、THE 本気モードエンジン SHALL ステークされたジェムを返却し、達成スコアを計算する
2. WHEN 1 Gemステークのタスクが完了する、THE 本気モードエンジン SHALL 通常の達成スコアを付与し、標準のお祝いアニメーションを表示する
3. WHEN 3 Gemsステークのタスクが完了する、THE 本気モードエンジン SHALL 達成スコア×1.2倍を付与し、強化されたお祝いアニメーションを表示する
4. WHEN 5 Gemsステークのタスクが完了する、THE 本気モードエンジン SHALL 達成スコア×1.5倍を付与し、特別な祝祭演出（アニメーション、サウンド）を表示する
5. WHEN 5 Gemsステークのタスクが完了する、THE 本気モードエンジン SHALL そのタスクを「黄金の成功体験」として永久アーカイブに保存する
6. WHEN 黄金の成功体験が保存される、THE バックエンド SHALL タスク詳細、達成日時、ユーザーの感情状態、AIコーチングログを含める
7. WHEN ユーザーが誠実性スコアブーストを持つ、THE 本気モードエンジン SHALL 達成スコアに追加のブースト（+10%）を適用する

### 要件 13：正直な撤退ボタン（Failure Acceptance）

**ユーザーストーリー：** ユーザーとして、タスクを完了できなかった時に、1タップで正直に失敗を報告し、認知不協和を防ぎたい。

#### 受入基準

1. WHEN ユーザーがステークされたタスクの詳細画面を開く、THE UI SHALL 「正直な撤退」ボタンを常時表示する
2. WHEN ユーザーが「正直な撤退」ボタンをタップする、THE UI SHALL 責めない言葉遣い（「今日は休む日だったんですね」）で確認ダイアログを表示する
3. WHEN ユーザーが失敗報告を確定する、THE 本気モードエンジン SHALL タスクを「正直に失敗」ステータスに設定する
4. WHEN 失敗が報告される、THE ジェム管理 SHALL ステークされたジェムを没収する（返却しない）
5. WHEN 失敗が正直に報告される、THE 本気モードエンジン SHALL ユーザーの誠実性スコアを+5ポイント増加させる
6. WHEN 誠実性スコアが増加する、THE バックエンド SHALL 新しいスコアを永続化し、次回成功時のブースト率を計算する
7. WHEN 失敗報告が完了する、THE UI SHALL サルベージ機能の案内を表示する（Proプランは月3回無料）
8. WHEN ユーザーが任意で失敗理由を入力する、THE バックエンド SHALL その理由をAIコーチングの文脈として保存する

### 要件 14：サルベージ（救済）機能

**ユーザーストーリー：** ユーザーとして、本気モードで失敗した際に、AIリカバリーセッションを受けて、次の挑戦への橋渡しをしてもらいたい。

#### 受入基準

1. WHEN ユーザーが失敗を報告する、THE 本気モードエンジン SHALL サルベージ機能の利用可否を確認する
2. WHEN Proプランユーザーが月3回以内のサルベージを利用する、THE 本気モードエンジン SHALL ジェムを消費せずにリカバリーセッションを開始する
3. WHEN Proプランユーザーが月4回目以降のサルベージを利用する、THE 本気モードエンジン SHALL 1 Gemの消費を確認し、同意後にセッションを開始する
4. WHEN 無料プランユーザーがサルベージを利用する、THE 本気モードエンジン SHALL 1 Gemの消費を確認し、同意後にセッションを開始する
5. WHEN リカバリーセッションが開始される、THE AI_サービス SHALL ACTの「認知的脱フュージョン」技法を用いた対話を生成する
6. WHEN リカバリーセッションが進行する、THE AI_サービス SHALL 以下の4段階を実行する：
   - 認知的脱フュージョン：失敗を責める思考から距離を置く
   - 受容の促進：「今は休む時間」と受容し、自己批判を軽減
   - 次へのブリッジ：5分でできる「超・マイクロタスク」を提案
   - パターン分析：失敗の背景要因を分析し、次回の成功確率を高める
7. WHEN リカバリーセッションが完了する、THE 本気モードエンジン SHALL セッション内容をユーザーの心理プロファイルに記録する
8. WHEN 月次サルベージカウントがリセットされる、THE バックエンド SHALL 毎月1日0時（ユーザーのタイムゾーン）にProプランユーザーのカウントを0にリセットする
9. WHEN ユーザーがサルベージ履歴を表示する、THE UI SHALL 今月の利用回数、残り無料回数（Proプランのみ）、過去のセッション概要を表示する

### 要件 15：AI伴走レベルの動的調整

**ユーザーストーリー：** ユーザーとして、ステークレベルに応じた適切なAI伴走を受けることで、過干渉でも放置でもない最適なサポートを得たい。

#### 受入基準

1. WHEN タスクのステークが0 Gems（通常タスク）である、THE AI_サービス SHALL ユーザーからの明示的な質問にのみ応答する
2. WHEN タスクのステークが1 Gemである、THE AI_サービス SHALL 静かに見守り、ユーザーからの質問に応答する
3. WHEN タスクのステークが3 Gemsである、THE 本気モードエンジン SHALL 期限の24時間前に1回の能動的リマインドを送信する
4. WHEN 3 Gemsステークのリマインドが送信される、THE AI_サービス SHALL タスクの重要性を再確認し、心理的障壁がないか尋ねる
5. WHEN タスクのステークが5 Gemsである、THE 本気モードエンジン SHALL 以下の3段階サポートを実行する：
   - 実行前（タスク作成後24時間以内）：意図の確認と心理的準備
   - 実行中（期限の50%経過時点）：進捗確認と障壁の除去
   - 完了後（完了直後）：振り返りと成功体験の言語化
6. WHEN 5 Gemsステークのタスクでユーザーが質問する、THE AI_サービス SHALL 他のタスクより優先的に応答する（応答時間を50%短縮）
7. WHEN AI伴走中にユーザーが「今は話したくない」と表明する、THE AI_サービス SHALL 即座に伴走を一時停止し、ユーザーの自律性を尊重する
8. WHEN 伴走が一時停止される、THE 本気モードエンジン SHALL 次回のリマインドタイミングを延期する（24時間後）

### 要件 16：黄金の成功体験アーカイブ

**ユーザーストーリー：** ユーザーとして、5 Gemsステークで達成した重要なタスクが永久保存され、後のコーチングで引用されることで、自己効力感を高めたい。

#### 受入基準

1. WHEN 5 Gemsステークのタスクが完了する、THE 本気モードエンジン SHALL そのタスクを「黄金の成功体験」としてマークする
2. WHEN 黄金の成功体験が作成される、THE バックエンド SHALL 以下の情報を永久保存する：
   - タスク名と詳細
   - 達成日時
   - ステーク量（5 Gems）
   - 達成スコア
   - 完了時の感情状態
   - AI伴走ログ（実行前・実行中・完了後の対話）
   - ユーザーの振り返りコメント
3. WHEN ユーザーが新しい困難なタスクに取り組む、THE AI_サービス SHALL 関連する黄金の成功体験を検索し、コーチングに引用する
4. WHEN 黄金の成功体験が引用される、THE AI_サービス SHALL 「あなたは以前、〇〇を達成しましたね」と具体的に言及する
5. WHEN ユーザーが黄金の成功体験一覧を表示する、THE UI SHALL 時系列順に並べ、各体験のサムネイル（タスク名、日付、感情）を表示する
6. WHEN ユーザーが特定の黄金の成功体験を開く、THE UI SHALL 完全な詳細、AI伴走ログ、振り返りコメントを表示する
7. WHEN ユーザーがアカウントを削除する、THE バックエンド SHALL 黄金の成功体験を含むすべてのデータを完全に削除する（GDPR準拠）

### 要件 17：誠実性スコアと報酬ブースト

**ユーザーストーリー：** ユーザーとして、失敗を正直に報告することで誠実性スコアが上がり、次回成功時の報酬がブーストされることで、正直さが報われる文化を体験したい。

#### 受入基準

1. WHEN ユーザーアカウントが作成される、THE バックエンド SHALL 誠実性スコアを初期値50に設定する
2. WHEN ユーザーが「正直な撤退」ボタンで失敗を報告する、THE 本気モードエンジン SHALL 誠実性スコアを+5ポイント増加させる
3. WHEN ユーザーがタスクを削除して失敗を隠す、THE 本気モードエンジン SHALL 誠実性スコアを-10ポイント減少させる
4. WHEN 誠実性スコアが変動する、THE バックエンド SHALL 新しいスコアを永続化し、変動理由をログに記録する
5. WHEN ユーザーがステークされたタスクを完了する、THE 本気モードエンジン SHALL 誠実性スコアに基づいてブースト率を計算する：
   - スコア0-30：ブーストなし
   - スコア31-60：+5%ブースト
   - スコア61-80：+10%ブースト
   - スコア81-100：+15%ブースト
6. WHEN ブースト率が計算される、THE 本気モードエンジン SHALL 基本達成スコアにブースト率を乗算する
7. WHEN ユーザーが誠実性スコアを表示する、THE UI SHALL 現在のスコア、次のブースト閾値、スコア履歴グラフを表示する
8. WHEN 誠実性スコアが100を超える、THE バックエンド SHALL スコアを100に制限する（上限）
9. WHEN 誠実性スコアが0未満になる、THE バックエンド SHALL スコアを0に制限する（下限）

### 要件 18：本気モード分析とインサイト

**ユーザーストーリー：** Proプランユーザーとして、本気モードの使用パターンと成功率を分析したレポートを受け取ることで、自己理解を深めたい。

#### 受入基準

1. WHEN Proプランユーザーが週次レポートを受け取る、THE AI_レポート SHALL 本気モードの使用統計を含める：
   - 週間ステーク総数（レベル別）
   - 成功率（レベル別）
   - 獲得した達成スコア
   - 誠実性スコアの変動
2. WHEN Proプランユーザーが月次レポートを受け取る、THE AI_レポート SHALL 本気モードの深い分析を含める：
   - 最も成功しやすいステークレベル
   - 失敗パターンの分析（時間帯、タスクタイプ）
   - 黄金の成功体験の振り返り
   - 次月への推奨戦略
3. WHEN レポートが生成される、THE AI_サービス SHALL ユーザーの心理プロファイルと本気モード履歴を統合して分析する
4. WHEN ユーザーが本気モードダッシュボードを開く、THE UI SHALL リアルタイム統計を表示する：
   - 現在のステーク中タスク数
   - 今月の成功率
   - 利用可能ジェム残高
   - サルベージ残り無料回数（Proプランのみ）
5. WHEN ユーザーが過去の本気モードタスクを検索する、THE バックエンド SHALL ステークレベル、成功/失敗、日付範囲でフィルタリングできる

---

## 技術的要件

### 要件 19：データモデルとスキーマ

**ユーザーストーリー：** 開発者として、収益化システムと本気モードを実装するための明確なデータモデルとスキーマを持ちたい。

#### 受入基準

1. THE バックエンド SHALL 以下のテーブルを実装する：
   - `subscriptions`: ユーザーID、プランタイプ、ステータス、開始日、終了日、更新日
   - `gem_transactions`: トランザクションID、ユーザーID、量、タイプ（付与/消費）、ソース、有効期限、タイムスタンプ
   - `gem_balances`: ユーザーID、利用可能ジェム、保留中ジェム、無期限ジェム、最終更新日
   - `commitment_tasks`: タスクID、ユーザーID、ステーク量、AI伴走レベル、ステータス、作成日、期限
   - `honesty_scores`: ユーザーID、現在スコア、履歴（JSON）、最終更新日
   - `salvage_sessions`: セッションID、ユーザーID、タスクID、セッション内容（JSON）、タイムスタンプ
   - `golden_successes`: ID、ユーザーID、タスクID、達成日時、感情状態、AI伴走ログ（JSON）、振り返り
   - `payment_transactions`: トランザクションID、ユーザーID、金額、タイプ、プラットフォーム、レシート、ステータス、タイムスタンプ

2. THE Isarローカルデータベース SHALL 以下のコレクションを実装する：
   - `User`: プランタイプ、ジェム残高、誠実性スコア、サルベージカウント
   - `Task`: ステーク量、AI伴走レベル、本気モードフラグ、黄金の成功体験フラグ
   - `GemTransaction`: ローカルトランザクション履歴（オフライン対応）
   - `CommitmentSession`: 本気モードセッションのローカルキャッシュ

3. THE データモデル SHALL E2E暗号化をサポートする：
   - 黄金の成功体験の詳細
   - サルベージセッション内容
   - AI伴走ログ
   - ユーザーの振り返りコメント

4. THE バックエンド SHALL インデックスを作成する：
   - `subscriptions.user_id`
   - `gem_transactions.user_id, timestamp`
   - `commitment_tasks.user_id, status`
   - `golden_successes.user_id, achieved_at`

### 要件 20：プラットフォーム固有の実装

**ユーザーストーリー：** 開発者として、各プラットフォームで適切な決済APIを使用して、一貫したユーザー体験を提供したい。

#### 受入基準

1. THE iOS実装 SHALL `in_app_purchase` パッケージを使用してApp Store決済を統合する
2. THE Android実装 SHALL `in_app_purchase` パッケージを使用してGoogle Play Billing APIを統合する
3. THE Web実装 SHALL Stripe等のWeb決済ゲートウェイを統合する
4. THE 決済システム SHALL プラットフォーム間でレシート検証を統一的に処理する
5. THE 決済システム SHALL サンドボックス環境とプロダクション環境を切り替え可能にする
6. THE 決済システム SHALL 決済失敗時のリトライロジックを実装する（最大3回）
7. THE 決済システム SHALL 決済処理中のローディング状態を適切に表示する

### 要件 21：オフライン対応とデータ同期

**ユーザーストーリー：** ユーザーとして、オフライン時でも本気モード機能を使用し、オンライン復帰時に自動同期されることを期待する。

#### 受入基準

1. WHEN ユーザーがオフラインでステークされたタスクを作成する、THE ローカルストレージ SHALL タスクとステーク情報を保存する
2. WHEN ユーザーがオフラインでタスクを完了する、THE ローカルストレージ SHALL 完了情報と達成スコアを保存する
3. WHEN ユーザーがオフラインで失敗を報告する、THE ローカルストレージ SHALL 失敗情報と誠実性スコア変動を保存する
4. WHEN ネットワーク接続が復帰する、THE 同期サービス SHALL ローカル変更をバックエンドに送信する
5. WHEN 同期中に競合が発生する、THE 競合解決サービス SHALL 最新のタイムスタンプを優先する
6. WHEN サルベージ機能がオフラインで要求される、THE UI SHALL オンライン接続が必要であることを通知する
7. WHEN ジェム残高がオフラインで変更される、THE ローカルストレージ SHALL 変更をキューに追加し、同期時にバックエンドと整合性を確認する

### 要件 22：セキュリティとプライバシー

**ユーザーストーリー：** ユーザーとして、決済情報と個人データが安全に保護されることを期待する。

#### 受入基準

1. THE 決済システム SHALL すべての決済通信にHTTPS/TLSを使用する
2. THE バックエンド SHALL クレジットカード情報を保存しない（決済プロバイダーに委譲）
3. THE バックエンド SHALL ジェム残高の変更にトランザクションログを記録する（監査証跡）
4. THE バックエンド SHALL 不正なジェム操作を検出するアノマリー検出を実装する
5. THE バックエンド SHALL ユーザーの黄金の成功体験をE2E暗号化して保存する
6. THE バックエンド SHALL サルベージセッション内容をE2E暗号化して保存する
7. THE バックエンド SHALL GDPR準拠のデータ削除機能を実装する（アカウント削除時）
8. THE バックエンド SHALL 決済トランザクションを7年間保存する（法的要件）

### 要件 23：パフォーマンスと可用性

**ユーザーストーリー：** ユーザーとして、決済とプレミアム機能が高速かつ信頼性高く動作することを期待する。

#### 受入基準

1. THE 決済システム SHALL 決済処理を30秒以内に完了する
2. THE サブスクリプション管理 SHALL サブスクリプション状態の変更を60秒以内に全デバイスに反映する
3. THE ジェム管理 SHALL ジェム残高の更新を5秒以内に完了する
4. THE 本気モードエンジン SHALL ステーク設定を3秒以内に処理する
5. THE AI_サービス SHALL 5 Gemsステークタスクの優先応答を通常の50%の時間で完了する
6. THE バックエンド SHALL 99.9%の可用性を維持する（月間ダウンタイム43分以内）
7. THE バックエンド SHALL 決済トランザクションのバックアップを毎日実行する

### 要件 24：エラーハンドリングとユーザー通知

**ユーザーストーリー：** ユーザーとして、エラーが発生した際に明確な説明と解決策を受け取りたい。

#### 受入基準

1. WHEN 決済が失敗する、THE UI SHALL エラーの種類（カード拒否、ネットワークエラー等）を明確に表示する
2. WHEN ジェム残高が不足する、THE UI SHALL 必要なジェム数と購入オプションを表示する
3. WHEN サブスクリプション更新が失敗する、THE 通知サービス SHALL ユーザーにプッシュ通知とメールを送信する
4. WHEN サルベージ機能がエラーになる、THE UI SHALL エラー内容とサポート連絡先を表示する
5. WHEN 同期が失敗する、THE UI SHALL リトライボタンと失敗理由を表示する
6. WHEN 本気モードエンジンがエラーになる、THE バックエンド SHALL エラーログを記録し、開発チームに通知する
7. THE エラーメッセージ SHALL 技術的詳細を避け、ユーザーフレンドリーな言葉を使用する

### 要件 25：テストとQA

**ユーザーストーリー：** 開発者として、収益化システムと本気モードが正しく動作することを確認するための包括的なテストを実施したい。

#### 受入基準

1. THE テストスイート SHALL 以下のユニットテストを含む：
   - ジェム残高計算
   - ステーク報酬計算
   - 誠実性スコア変動
   - 有効期限管理
   - ブースト率計算

2. THE テストスイート SHALL 以下の統合テストを含む：
   - サブスクリプション購入フロー（エンドツーエンド）
   - ジェム購入フロー（エンドツーエンド）
   - 本気モードタスク作成から完了まで
   - サルベージセッションフロー
   - 黄金の成功体験作成と引用

3. THE テストスイート SHALL 以下のエッジケーステストを含む：
   - ジェム残高がちょうど0の場合
   - 有効期限が今日の場合
   - サブスクリプション更新日とジェム付与のタイミング
   - オフライン時の本気モード操作
   - 同時に複数のステークタスクを完了

4. THE テストスイート SHALL 決済のモックテストを含む（実際の課金なし）

5. THE テストスイート SHALL パフォーマンステストを含む：
   - 1000件のジェムトランザクション処理
   - 100件の同時サブスクリプション更新
   - 大量の黄金の成功体験検索

---

## 実装優先順位

### フェーズ1：基礎インフラ（必須）
1. データモデルとスキーマ実装
2. 決済システム統合（プラットフォーム別）
3. サブスクリプション管理
4. ジェム管理（残高、有効期限）
5. 機能ゲート（AI レポート、マルチデバイス同期）

### フェーズ2：本気モードコア（高優先度）
1. ステークシステム
2. タスク完了とステーク報酬
3. 正直な撤退ボタン
4. 誠実性スコアと報酬ブースト
5. AI伴走レベルの動的調整

### フェーズ3：本気モード拡張（中優先度）
1. サルベージ機能
2. 黄金の成功体験アーカイブ
3. 本気モード分析とインサイト
4. 週次・月次レポート統合

### フェーズ4：最適化と拡張（低優先度）
1. オフライン対応の強化
2. パフォーマンス最適化
3. 高度な分析とインサイト
4. A/Bテスト機能

---

## 成功指標（KPI）

### ビジネスKPI
- **Pro プラン転換率**: 無料ユーザーの20%以上がProプランに転換
- **月間継続率**: Proプランユーザーの90%以上が翌月も継続
- **ARPU（ユーザーあたり平均収益）**: ¥300以上（全ユーザー平均）
- **ジェム購入率**: 無料ユーザーの10%以上が単発購入

### エンゲージメントKPI
- **本気モード使用率**: Proプランユーザーの70%以上が月1回以上使用
- **ステーク成功率**: 全体で60%以上（レベル別に分析）
- **正直な撤退使用率**: 失敗タスクの80%以上が正直に報告される
- **サルベージ利用率**: 失敗報告の50%以上がサルベージを利用
- **黄金の成功体験数**: Proプランユーザーあたり月平均1件以上

### 技術KPI
- **決済成功率**: 95%以上
- **同期遅延**: 60秒以内
- **システム可用性**: 99.9%以上
- **エラー率**: 全トランザクションの1%未満

---

## まとめ

本要件定義書は、Kokosidの収益化システムと本気モード（Commitment Mode）の包括的な実装仕様を定義しています。

**コアバリュー**:
- 心理的安全性：失敗を受容し、正直さを報酬化
- 経済的持続性：フリーミアムモデルで幅広いユーザーに価値提供
- 行動変容：損失回避性とAI伴走で実行動機を最大化

**技術的特徴**:
- マルチプラットフォーム対応（iOS、Android、Web）
- E2E暗号化によるプライバシー保護
- オフライン対応とシームレスな同期
- スケーラブルなSupabaseバックエンド

この仕様に基づいて実装することで、「失敗してもこのAIがいれば大丈夫」という圧倒的な安心感と、「人生の転換点を一緒に乗り越えるパートナー」としての価値を提供します。
